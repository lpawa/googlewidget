<?xml version="1.0" encoding="UTF-8" ?>
<Module>
<ModulePrefs title="Get Events Test" height="500" author="lakshya" author_email="lakshyapawa@google.com">
<Require feature="google.calendar-0.5"/>
<Require feature="google.calendar-0.5.read"/>
</ModulePrefs>
<Content type="html">
<![CDATA[
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"> 
<html>
<head>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i&amp;subset=cyrillic,greek,vietnamese" rel="stylesheet">
<style>

.noselect {
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome and Opera */
}

ul {
    padding: 0px;
    float: left;
}
ul li {
    margin: 10px 0px;
    font-size: 14px;
    border-left: 2px solid #03A9F4;
    padding: 5px;
    list-style-type: none;
    float: left;
    cursor:pointer;
    font-family: 'Roboto', sans-serif;
    font-weight: 300;
    width: 100%;
    word-wrap: break-word;
}
ul li.active {
      background: #03A9F4;
    color: #fff;
}
button {
    cursor:pointer;
    display: block;
    background: #C0CA33;
    border: 0px;
    color: #fff;
    float: left;
    padding: 5px;
    margin: 0px 5px;
    font-family: 'Roboto', sans-serif;
    font-weight: 300;
}
.pop {
    cursor:pointer;
    display: block;
    background:#D44937;
    border: 0px;
    color: #fff;
    float: left;
    margin: 5px 5px;
    font-family: 'Roboto', sans-serif;
    font-weight: 300;
    font-size:10px;
}
.check{
  
  cursor:pointer;
    display: block;
        float: left;
    padding: 1px;
    margin-bottom: 6px;
    font-family: 'Roboto', sans-serif;
    font-weight: 500;
}
.sendInvite{
font-size:12px;
}
p{
padding:0px;
margin:0px;
}
</style>
</head>
<body>

<script> 

        var viewer = null; 
        var curEventId = null;    
        var storedEvents = null;
        var refreshEvents = 0;
        var i =0;
        var ownerEvents = [];
        var calendarStartDate=null;
        var calendarEndDate=null;
        var publishFlag = -1;

        var EventTemplate={
        "userId":"143",
        "title":"",
        "hashtag":"",
        "description":"",
        "type":"Normal",
        "startDateTime":"",
        "endDateTime":"",
        "linkLiveDate": "",
        "linkExpiryDate": "",
        "imageURLId":"",
        "thankYouNote":"Thank You!",
        "isReversed":false,
        "isOrgEvent":false,
        "moods":[
        {"moodName":"Excited","moodType":"EXCITED","order":1},
        {"moodName":"Indifferent","moodType":"INDIFFERENT","order":3},
        {"moodName":"Unhappy","moodType":"UNHAPPY","order":5},
        {"moodName":"Happy","moodType":"HAPPY","order":2},
        {"moodName":"Bored","moodType":"BORED","order":4},
        {"moodName":"Angry","moodType":"ANGRY","order":6}]

        }

        var TestTemplate={
        "userId":"143",
        "title":"a test data",
        "hashtag":"atestdata",
        "description":"something cool",
        "type":"Normal",
        "startDateTime":"2017-03-01 07:10:00",
        "endDateTime":"2017-05-24 07:10:00",
        "linkLiveDate": "2017-03-01 07:10:00",
        "linkExpiryDate": "2017-05-24 07:10:00",
        "imageURLId":"",
        "thankYouNote":"Thank You!",
        "isReversed":"false",
        "isOrgEvent":"false",
        "moods":[
        {"moodName":"Excited","moodType":"EXCITED","order":1},
        {"moodName":"Indifferent","moodType":"INDIFFERENT","order":3},
        {"moodName":"Unhappy","moodType":"UNHAPPY","order":5},
        {"moodName":"Happy","moodType":"HAPPY","order":2},
        {"moodName":"Bored","moodType":"BORED","order":4},
        {"moodName":"Angry","moodType":"ANGRY","order":6}]

        }

        var TestTemplate2 = {
  "userId":"68",
  "title":"Idris Event7",
  "hashtag":"IdrisEvent7",
  "description":"Let's make this event big!",
  "type":"Normal",
  "startDateTime":"2017-03-10 07:10:10",
    "endDateTime":"2017-05-24 10:10:10",
  "linkLiveDate": "2017-03-10 07:10:10",
    "linkExpiryDate": "2017-05-24 10:10:10",
  "imageURLId":"2",
  "thankYouNote":"Thank You!",
  "isReversed":"false",
  "isOrgEvent":"true",

}

function preferencesCallback(prefs) {
  var out = '';
  if ('startdow' in prefs) {
    out += "Day of week = " + prefs.startdow + "\n";
  }
  if ('military' in prefs) {
    out += "Military time = " + prefs.military + "\n";
  } 
  viewer=prefs.viewer;
  console.log(out);
}

// Ask the calendar for the preferences
google.calendar.getPreferences(preferencesCallback);

console.log("Start");

function drawScreen(){
  console.log("drawing begins");
  var count = (storedEvents && storedEvents.length) || 0;
  var out = '';
  if(storedEvents.length>0){
  for(var i = 0; i < count; ++i) {
    var e = storedEvents[i];
    if ('title' in e) {
      if(e.startTime.minute<10){
      minS = "0"+e.startTime.minute;
      }
      else{
      minS=e.startTime.minute;
      }
         if(e.endTime.minute<10){
      minE = "0"+e.endTime.minute;
      }
      else{
      minE=e.endTime.minute;
      }
      out += '<div id ="div'+ i +'"><li class = "noselect" id = "li'+i+'" onclick="showButtons('+i+')">' + e.title + "<br> From-" +e.startTime.date+"/"+e.startTime.month+"/"+e.startTime.year+"  "+e.startTime.hour+":"+minS+ "<br> To-" +e.endTime.date+"/"+e.endTime.month+"/"+e.endTime.year+"  "+e.endTime.hour+":"+minE +'</li><div class = "noselect check" id = "check'+i+'" style="display:none"><input id="cb'+i+'" type="checkbox" name="Send Invites" value="sendInvites" checked="checked"><label class = "sendInvite">Send Invites to attendees</label><br></div><p class = "noselect pop" id = "pop'+i+'" style="display:none" onclick="ShowEvent('+i+')">The hashtag is not unique.Click to change</p><button class="but'+ i +'" id ="butA'+ i +'" style="display:none" onclick="CheckHashtag('+i+')" style="display:none">Publish </button > <button class="but'+ i +'" id ="butB'+ i +'" style="display:none" onclick="PublishandEdit('+i+')">Edit</button></div>\n';
    }
    }
    }
    else{
    out='No events in next 7 days';
    }
  
    
  var html=out;
 document.getElementById('out').innerHTML = html;

}
function PublishandEdit(id){
  var e = storedEvents[id];
  var data = EventTemplate;
  data.title = e.title;
  var str = e.title.replace(/\s/g,'');
  str = str.replace(/[^a-zA-Z ]/g, "");
  data.hashtag = str;
   if(e.details){
  data.description = e.details;
  }
  else{
  data.description = e.title;
  }
  data.startDateTime=e.startTime;

  data.endDateTime=e.endTime;

  data.linkLiveDate= e.startTime;
  data.linkExpiryDate = e.endTime;

  data.linkLiveDate.date = e.startTime.date - 1;
  data.linkExpiryDate.date = e.endTime.date + 1;

  if($("#cb"+id).is(':checked')){
        data.attendee = e.attendees;
        console.log("Call Invite function");
    }
  console.log("Publish and Edit:- ");

  console.log(data);
  str = JSON.stringify(data);
  console.log(str);
  var obj = {};
  obj.data = str;

   $.ajax({
    url: 'https://staging-app.cavantics.com/api/preEventData',
    headers: {
        'Authorization':'Bearer ' + localStorage.getItem("jwt"),
        'content-type':'application/json',
        'Access-Control-Allow-Origin'  : '*', 
    'Access-Control-Allow-Headers' : 'Content-Type'   
    },
    method: 'POST',
    dataType: "json", 
    data: str,
    processData: false,
    success: function(datas){
      console.log('success: '+datas);
      if(datas.status=true){
        console.log(datas.responseData);
        var url = 'https://staging-app.cavantics.com/#/admin/moodcapture/edit/' +datas.responseData.id;
      window.open(url, '_blank');
      }
    }
  });


  

}
function CheckHashtag(id){
    var status;

    var e = storedEvents[id];
    var data = EventTemplate;
    var str = e.title;
    str = str.replace(/\W/g, '');
    $.ajax
({
  type: "GET",
  url: "https://staging-app.cavantics.com/api/checkHashtagExist/"+str,
  dataType: 'json',
  headers: {
    'Authorization':'Bearer '+ localStorage.getItem("jwt")
    
  },
  success: function (data){
    console.log("data.status"); 
  }
})
    .done(function(result){
      status= result.status;
      console.log(status);
      if(status){
        Popup(id);
      }
      else{
      CreateActivity(id);
      }
    })
}

function Popup(id){
  if(publishFlag>-1 && publishFlag!=id)
  {
    var p2 = document.getElementById('pop'+publishFlag);
    $(p2).toggle();
  }
  console.log("Popup called")
  var p1 = document.getElementById('pop'+id);
  $(p1).toggle();
  if(publishFlag!=id){
    publishFlag= id;
    }
    else{
    publishFlag = -1;
    }
   
 }

function CreateActivity(id){
  var e = storedEvents[id];
  var data = EventTemplate;
  data.title = e.title;
  var str = e.title;
  str = str.replace(/\W/g, '');
  data.hashtag = str;
  if(e.details){
  data.description = e.details;
  }
  else{
  data.description = e.title;
  }
  data.startDateTime=e.startTime.year+"-"+e.startTime.month+"-"+e.startTime.date+" " +e.startTime.hour+":" + e.startTime.minute+ ":" + e.startTime.second;

  data.endDateTime=e.endTime.year+"-"+e.endTime.month+"-"+e.endTime.date+" " +e.endTime.hour+":" + e.endTime.minute+ ":" + e.endTime.second;

  var linkStartDay = e.startTime.date - 1;
  var linkEndDay = e.endTime.date + 1;
  var attendee = null;
  data.linkLiveDate=e.startTime.year+"-"+e.startTime.month+"-"+linkStartDay+" " +e.startTime.hour+":" + e.startTime.minute+ ":" + e.startTime.second;

  data.linkExpiryDate=e.endTime.year+"-"+e.endTime.month+"-"+linkEndDay+" " +e.endTime.hour+":" + e.endTime.minute+ ":" + e.endTime.second;

  console.log(data);
  
     if($("#cb"+id).is(':checked')){
        attendee = e.attendees;
        console.log("Call Invite function");
    }

  $.ajax({
    url: 'https://staging-app.cavantics.com/api/moodCaptureEvent',
    headers: {
        'Authorization':'Bearer ' + localStorage.getItem("jwt"),
        'content-type':'application/json',
        'Access-Control-Allow-Origin'  : '*', 
    'Access-Control-Allow-Headers' : 'Content-Type'   
    },
    method: 'POST',
    dataType: "json", 
    data: JSON.stringify(data),
    processData: false,
    success: function(datas){
      console.log('success: '+datas);
      if(attendee){
        sendInvites(datas , attendee);
      }
    }
  });
}

function sendInvites(data, attendee){
  var template = { "eventId":data.responseData[0].eventId,
"userId":localStorage.getItem("userdata").id,
"flag":"emailIds",
"emailIds":[],
"mobileNos":[]
}

for(var i=0;i< attendee.length;i++){
  template.emailIds.push({
    "email" : attendee[i].email,
    "userId" : ""
  });
}
console.log(template);
$.ajax({
    url: 'https://staging-app.cavantics.com/api/moodCaptureInvitees',
    headers: {
        'Authorization':'Bearer ' + localStorage.getItem("jwt"),
        'content-type':'application/json',
        'Access-Control-Allow-Origin'  : '*', 
    'Access-Control-Allow-Headers' : 'Content-Type'   
    },
    method: 'POST',
    dataType: "json", 
    data: JSON.stringify(template),
    processData: false,
    success: function(datas){
      console.log('success: '+datas.status);
     
    }
  });

}

function eventCallback(response) {
  console.log("Callback Events called");
  var Response = response[0];
  if ('error' in response[0]) {
    alert('Something went wrong');
    return;
  }
  if (response && response.length > 0) {
    x = response[0].events;
    var k=0;
    ownerEvents=[];
    for(l=0;l<x.length;l++){
    var e = x[l];
    if(e.owner.email==viewer){
    console.log(e);
    console.log(l);
    console.log(k);
    ownerEvents[k]=e;
    k++;
    }
    }
  } else {
    storedEvents = [];
  }
  console.log(response[0].events);
  console.log(ownerEvents);
  storedEvents=ownerEvents;
  drawScreen();
  
}  
var start = new Date();
start.setDate(start.getDate() - 7);
calendarStartDate = google.calendar.utils.fromDate(start);
  var end = new Date();
  end.setDate(end.getDate() + 7);
calendarEndDate = google.calendar.utils.fromDate(end);
  startTime = {year: 20017, month: 12, date : 25};
        endTime = {year: 2018, month: 12, date : 26};

function getEvent()
{
var optionalParams = { 'requestedFields': ['owner', 'status', 'attendeeCount', 'details', 'attendees'] }; 
console.log("Events trying to be fetched");
console.log("Start time:-" + start);
console.log(calendarStartDate)
console.log("End time:-" + end);
console.log(calendarEndDate);
google.calendar.read.getEvents(eventCallback, ["lakshya.pawa@sproutlogix.com"], calendarStartDate ,calendarEndDate,optionalParams);
console.log("Events should have been fetched");
}
function setupEventRetrieval() {
  <!-- // Ask the container for the next few events. -->
        getEvent();
  <!-- // Request that we be called back when the date changes
  // and then re-fetch the next events. -->
        google.calendar.subscribeToDataChange(getEvent);
}
function ShowEvent(id){
  var e = storedEvents[id];
  var eid = e.id;
  google.calendar.showEvent(eid);
}
function showButtons(id)
{         
    var b1 = document.getElementById('butA'+id);
    var b2 = document.getElementById('butB'+id);
    var li = document.getElementById('li'+id);
    var check = document.getElementById('check'+id);
    if(publishFlag>-1){
    var p2 = document.getElementById('pop'+publishFlag);
    $(p2).toggle();
    publishFlag=-1;
    }
    if(curEventId>-1&&curEventId!=id){
      var b3 = document.getElementById('butA'+curEventId);
    var b4 = document.getElementById('butB'+curEventId);
    var check2 = document.getElementById('check'+curEventId);
    $(b3).toggle();
    $(b4).toggle();
    $(check2).toggle();
    }
    console.log(b1);
    console.log(b2);
    if(b1){
    $(b1).toggle();
    $(b2).toggle();
    $(check).toggle();
    if(curEventId!=id){
    curEventId= id;
    }
    else{
    curEventId = -1;
    }
    }
}
setupEventRetrieval();
function signIn(){

    var childWin = window.open("https://staging-app.cavantics.com/#/signingoogle", "_blank", "height=600, width=450, status=yes, toolbar=no, menubar=no, location=no,addressbar=no"); 

  
}
function receiveMessage(event) {
    // Check to make sure that this message came from the correct domain
    if (event.origin !== "https://staging-app.cavantics.com"){
    console.log(event.origin);
    console.log("Some other origin");
    return;
    }
    // Update the div element to display the message.
    console.log("Message Received: ");
    console.log(event.data);
    localStorage.setItem("userdata",JSON.stringify(event.data.user));
    localStorage.setItem("jwt",event.data.token);
  }

  // Setup an event listener that calls receiveMessage() when the window
  // receives a new MessageEvent.
  window.addEventListener('message', receiveMessage);


  function setData(data) {
        console.log(data);
        var strData = JSON.stringify(data);
    }
 </script> 
 <form action="https://staging-app.cavantics.com/sso/auth0Library" method="post" name="getStorageDataForm">
    <input type="hidden" name="type" value="login" />
    <input type="hidden" name="email" value="" />
    <input type="hidden" id="signinCallback" name="callbackURL" value="https://calendar.google.com"/>
</form>
 <button id= "signin" onclick="signIn()">Sign In With Google</button>
 <ul id="out">loading</ul>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
 <script src="https://cdn.auth0.com/js/auth0/8.7/auth0.min.js"></script>
</body>
</html>
]]>
</Content>
</Module>
